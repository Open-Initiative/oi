{% load oifilters %}
{% load i18n %}
{% if task|can_read:user %}


    <div id="featurebudget_{{task.id}}" class="featuredetail invisible" onclick="document.ignoreClosePopups = true;">
        <div id="prjdialogue_{{task.id}}" class="popup invisible"></div>
        {% include 'funding/feature_budget.html' %}
    </div>
    
    {% if task.state < 4 and task|can_bid:user or not user.is_authenticated %}
    <div id="bidpopup_{{task.id}}" {% if plugin_width %}style="width:{{plugin_width}};"{% endif %} class="popup_spec invisible" onclick="document.ignoreClosePopups = true;">
            <img style="position: relative;top: 14%;" class="clickable actions" src="/img/icons/delete.png" alt="{% trans 'close' %}" title="{% trans 'close' %}" onclick="hidePopups()" />
            <div class="cleared"></div>
            <p class="bid_popup_title form_center">{% trans "Support the feature" %} <b>{{task.title}}</b><br/> {% trans "on the project" %} <u>{{object.title}}</u></p>
            <div class="cleared"></div>
        <p>{% trans "By funding this feature you will enable improvements to this software. You will be given the chance to validate that the development is done the way you want. An e-mail will let you know that you can test the feature when it is developped, so that you can validate it is done."%}</p><p>{% trans "Thanks for supporting this software!" %}</p>
        
        <form class="form_center" onsubmit="OIajaxCall('/project/confirmbid/{{task.id}}', 'bid='+getValue('bid_{{task.id}}'), 'output');return false">
            <label for="bid_{{task.id}}">{% trans "Please enter the amount you want to fund:" %}</label><br /><br />
            <input style="left: 44%;position: relative;top: -10%;" id="bid_{{task.id}}" name="bid_{{task.id}}" class="bidfeature" value="{{task.missing_bid|floatformat:"-2"}}" /> €
        </form>
        
        <p class="form_center">{% trans "By funding this feature, you agree to the" %} <a href="/cgu" target="_blank">{% trans "Terms of Use" %}</a></p>
        <span style="position: relative;left: -3%;top: 2%;" class="fundingright continuebtn clickable" onclick="OIajaxCall('/project/confirmbid/{{task.id}}', 'bid='+getValue('bid_{{task.id}}'), 'output')">{% trans "Continue" %}</span>
    </div>
    
    {% endif %}

    <div id="featureDiv_{{task.id}}" class="featureblock" title="{{task.title}}" style="padding: 1%;{% if not task.public_read %} opacity:.4;{% endif %}">
        <div id="feature_{{task.id}}" class="featuretitle clickable" onclick="expandFeature({{task.id}})">{{task.title}}</div>
        <form onsubmit="var newtitle = getValue('feature_{{task.id}}_edit');if(newtitle){confirmEditTitle({{task.id}}, newtitle);}; seeMore('feature_{{task.id}}_edit', 'feature_{{task.id}}'); return false">
        <input id="feature_{{task.id}}_edit" class="featuretitle invisible" value="{{task.title}}">
        </form>
        <div class="fundingright form_center" style="min-width: 30%;">
            <div><span class="funded">{{task.allbid_sum|default:0|floatformat:"-2"}} €</span> {% trans "funded" %}</div>
            <div class="progressbar">
                <span id="progressbar_{{object.id}}" class="progress" style="width:{% widthratio task.allbid_sum|default:0 task.get_budget|default:0 100 %}%;">{% widthratio task.allbid_sum|default:0 task.get_budget|default:0 100 %}%</span>
                <span id="progresslabel_{{object.id}}" class="progresstitle" ></span>
            </div>
            <div class="cleared funding_space">
                <span class="amount">{{task.get_budget|default:0|floatformat:"-2"}} €</span> {% trans "needed" %} -
                <span class="amount">{{task.missing_bid|floatformat:"-2"}} €</span> {% trans "to go" %}
            </div>
            
            {% if task.state < 4 and task.assignee == user %}
                <form class="funding_space" onsubmit="OIajaxCall('/project/confirmoffer/{{task.id}}', 'offer='+getValue('offer_manage_{{task.id}}'), 'output', function(){hide('offer_manage_{{task.id}}')}); return false">
                    <input type="text" id="offer_manage_{{task.id}}" value="{{task.offer}}" onFocus="this.select()" class="smallinput invisible" />
                    <span id="changesum_{{task.id}}">{% trans "Change the price of this feature" %}</span>
                    <img src="/img/icons/edit.png" class="clickable" onclick="$('#offer_manage_{{task.id}}').toggle(); $('#changesum_{{task.id}}').toggle(); $('#ok_{{task.id}}').toggle()">
                    <img id="ok_{{task.id}}" src="/img/icons/ok.png" class="clickable invisible" onclick="OIajaxCall('/project/confirmoffer/{{task.id}}', 'offer='+getValue('offer_manage_{{task.id}}'), 'output', function(){hide('offer_manage_{{task.id}}')});">
                </form>
            {% endif %}
            
            {% include 'funding/project_actions.html' %}
            <div class="featurebtns">
            {% if task.state < 4 and task|can_bid:user or not user.is_authenticated %}
                <span class="supportbtn clickable" onclick="showPopup(document.getElementById('bidpopup_{{task.id}}')); ">{% trans "Support" %}</span>
            {% endif %}
            </div>
            <a class="clickable" onclick="showPopup(document.getElementById('featurebudget_{{task.id}}'))">{{task.bid_set.count}} {% trans "funders" %}</a>
            
            {% if task|can_manage:user %}
            <div class="cleared funding_space"></div>
            <div id="visible_{{task.id}}">
                <form>
                   <label>{% trans "Visible feature to the users" %}</label> 
                   <input id="public_read_{{task.id}}" type="checkbox" {% if task.public_read %}checked="checked"{% endif %} onclick="visibleFeature({{task.id}})">
                </form>
            </div>
            {% endif %}
            
        </div>
        
        {% if task|can_write:user and task.state < 4 %}<span class="editfeature">
            {% if task.state < 2 %}{% trans "Edit" %} <img src="/img/icons/edit.png" alt="{% trans 'edit title' %}" title="{% trans 'edit title' %}" class="clickable" onclick="seeMore('feature_{{task.id}}_edit', 'feature_{{task.id}}')" />{% endif %}
            {% trans "Delete" %} <img src="/img/icons/delete.png" alt="{% trans 'delete feature' %}" title="{% trans 'delete feature' %}" class="clickable" onclick="deleteFeature({{task.id}})" />
        </span>{% endif %}
        
        <div id="specs_{{task.id}}_hide" class="coverferture">
        {% for spec in task.spec_set.all %}
            {% if spec.order == 1 %}
                {{spec.text|oiunescape|summarize_html}} {% if spec.text|length > 101 %}...{% endif %}
            {% endif %}
        {% endfor %}
        </div>
        
            {% if task|can_manage:user or task.spec_set.count %}
                {% include 'funding/feature_description.html' %}
            {% else %}
                <input id="specs_{{task.id}}" type="hidden">
                <input id="see_more_{{task.id}}" type="hidden">
                <input id="see_less_{{task.id}}" type="hidden">
            {% endif %}
        
        <div class="cleared">
            {% if task|can_manage:user or task.spec_set.count%}
            <a id="see_more_{{task.id}}" class="clickable see-more" onclick="expandFeature({{task.id}});{% if task|can_write:user and task.state < 4 and task.spec_set.all.count < 1 %}addSpec('{{task.id}}')">{% trans "Add a description" %}{% else %}">{% trans "See more" %}{% endif %}</a>
            
            <a id="see_less_{{task.id}}" class="clickable invisible see-less" onclick="expandFeature({{task.id}})">{% trans "See less" %}</a>
            {% endif %}
        </div>
        
    </div>
    <script>
        $(function() {
            $("#featurebudget_{{task.id}}").draggable();
        });
        $( document ).ready(function() {
            if(document.location.hash=='#feature_{{task.id}}'){
                show('specs_{{task.id}}');
                hide('specs_{{task.id}}_hide');
                hide('see_more_{{task.id}}');
                show('see_less_{{task.id}}');
            }
        });
    </script>

{% endif %}
