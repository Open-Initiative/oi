{% extends "funding/base.html" %}
﻿﻿{% load oifilters %}
{% load i18n %}
{% block title %}{{object.title|default:_("Project")}}{% endblock %}
{% block breadcrumb %}
<div class="path-element">{{object.title}}</div>
{% endblock %}

{% block content %}
{% if object|can_read:user %}
<div class="prjbody">
    {% with object as project %}
    <div id="project_{{object.id}}" class="project">
        <div id="prjdialogue_{{object.id}}" class="popup invisible"></div>
        <div class="prjheader">
            <div>
                <img id="btn_extend_close" class="invisible btn_extend_close" src="/img/icons/btn_extention_close.png" onclick="$('#related').toggle()" />
            </div>
            <div>
                {% with spec=project.spec_set.all|filter_order:1 object=project %}
                <div style="position:relative; float:right" id="spec_{{object.id}}_{{spec.order}}" class="funding_space">
                    {%include 'funding/spec/spec.html'%}
                </div>
                {% endwith %}
                <div class="prj-block-fav">
                    <img onclick="favProject(174)" src="/img/icons/starTrueFunding.png" alt="{% trans 'follow the project' %}" title="{% trans 'follow the project' %}" class="clickable followicon" id="fav_174" />
                    {{object.observer_set.count}} {% blocktrans count counter=object.observer_set.count %} subscriber {% plural %} subscribers {% endblocktrans %}
                </div>
                <div class="tasktitle" id="prjtitle_{{object.id}}" title="{{object.title}}">
                    {{object.title}}
                </div>
            </div>
        </div>
        <div id="specs_{{project.id}}" class="prjdesc">
            {% for spec in project.all_specs_with_languages %}
                <div style="position:relative;" id="spec_{{object.id}}_{{spec.order}}" class="funding_space">
                    {% with project as object %}{%include 'funding/spec/spec.html'%}{% endwith %}
                </div>
            {% endfor %}
        </div>
        <div class="cleared"></div>
    </div>
    
    {% with object.descendants|filter_read:user as tasks %}
    {% if object|can_manage:user or tasks.count %}
    <div class="project">
        <h2 class="detail_subtitle">{% trans "Proposed features" %}</h2>
        
        <div>
            <div id="featureid_blockHead" class="statebtns center_btn"> 
                {% if object.all_not_started_tasks %}<div onclick="featureShowHide('features_0')" id="featureid_proposed" class="clickable statebtn invisible">{% trans "Proposed" %}</div>{% endif %}
                {% if object.all_progress_tasks %}<div onclick="featureShowHide('features_3')" id="featureid_progress" class="clickable statebtn invisible">{% trans "In progress" %}</div>{% endif %}
                {% if object.all_finish_tasks %}<div onclick="featureShowHide('features_4')" id="featureid_finished" class="clickable statebtn invisible">{% trans "Finished" %}</div>{% endif %}
                <div class="cleared"></div>
            </div>

            <ul class="features_manage" id="features_0">
                {% for task in object.all_not_started_tasks|filter_read:user %}
                    <li id="task_{{task.id}}">
                    {% include 'funding/feature.html' %}
                    </li>
                {% endfor %}
            </ul>
            <div class="cleared"></div>

            <ul class="features_manage" id="features_3">
                {% for task in object.all_progress_tasks|filter_read:user %}
                    <li id="task_{{task.id}}">
                    {% include 'funding/feature.html' %}
                    </li>
                {% endfor %}
                <div class="cleared"></div>
            </ul>

            <ul class="features_manage" id="features_4">
                {% for task in object.all_finish_tasks|filter_read:user %}
                    <li id="task_{{task.id}}">
                    {% include 'funding/feature.html' %}
                    </li>
                {% endfor %}
                <div class="cleared"></div>
            </ul>
            
        </div>
    </div>
    {% endif %}
    {% endwith %}
    {% endwith %}
    
    {% if object|can_manage:user or object|can_answer:user %}
    <div class="submit_feature">
        {% if object|can_manage:user %}
        <div class="column maxwidth50">
            <div class="bordertitledetails">
                <div class="navtitlehome oigreen">{% trans "What you have to do :" %}</div>
                <p>
                    {% trans "You can create and edit new developments for your projects. Specify the title, make a description that explains its characteristics and determine the expected price for each. Your users can suggest other developments on the project page, you can accept / rephrase if you wish." %}
                </p>
            </div>
        </div>
        <div class="column maxwidth50">
            <div class="blockfeatureheight">
                <form id="submit_title_price_{{object.id}}" onsubmit="addTask(getValue('newtask_title_{{object.id}}', true), {{object.id}}, getValue('offer_{{object.id}}'), function(taskid){OIajaxCall('/funding/'+taskid+'/task', null, newDiv('features_0'))}); document.getElementById('offer_{{object.id}}').value = ''; return false">
                    <table>
                        <tr>
                            <td>
                            <label class="loginlabel oigreen" for="newtask_title_{{object.id}}">{% trans "insert a title" %}</label>
                        <input type="text" class="fieldfeature" id="newtask_title_{{object.id}}" onkeyup="focusInOut('newtask_title_{{object.id}}')">
                        <div class="cleared"></div>
                                </td>
                        </tr>
                        <tr>
                            <td>
                                <label class="loginlabel oigreen" for="offer_{{object.id}}">{% trans "Feature price" %}</label>
                                <input type="text" class="fieldfeature" id="offer_{{object.id}}" onkeyup="focusInOut('offer_{{object.id}}')">  €
                                <div class="cleared"></div>
                            </td>
                        </tr>
                    </table>
                    <p>{% trans "By adding this change you acknowledge that you have read and accepted the" %} <a href="/cgu">{% trans "Terms of Use" %}</a></p>
                    <input type="submit" hidden>
                </form>
                <div class="cleared"></div>
            </div>
            <span class="clickable continuebtn fundingright" onclick="$('#submit_title_price_{{object.id}}').submit()">{% trans 'Propose' %}</span>
        </div>
        {% else %}
            {% if object|can_answer:user %}
            <div class="column maxwidth50">
                <div class="bordertitledetails">
                    <div class="navtitlehome oigreen">{% trans "Propose a new feature" %}</div>
                    <p>
                        {% trans "You can propose to the developer a new feature for this project. If it is accepted by the developer, the feature will be included in the project." %}
                    </p>
                </div>
            </div>
            <div class="column maxwidth50">
                <div class="blockfeatureheight">
                    <form id="submit_title_{{object.id}}" onsubmit="addTask(getValue('newtask_title_{{object.id}}', true), {{object.id}}, null,function(taskid){OIajaxCall('/funding/'+taskid+'/task', null, newDiv('features_0','featurebox'))}); return false" id="newtask_{{object.id}}">
                        <table>
                            <tr>
                                <td>
                                <label class="loginlabel oigreen" for="newtask_title_{{object.id}}">{% trans "insert a title" %}</label>
                                <input type="text" class="fieldfeature" id="newtask_title_{{object.id}}" onkeyup="focusInOut('newtask_title_{{object.id}}')">
                                </td>
                            </tr>
                        </table>
                        <p>{% trans "By adding this change you acknowledge that you have read and accepted the" %} <a href="/cgu">{% trans "Terms of Use" %}</a></p>
                        <input type="submit" hidden>
                    </form>
                    <div class="cleared"></div>
                </div>
                <span class="continuebtn fundingright clickable" onclick="$('#submit_title_{{object.id}}').submit()">{% trans 'Propose' %}</span>
            </div>
            {% endif %}
        {% endif %}
        <div class="cleared"></div>
    </div>
    {% endif %}
    
</div>

{% with object as project %}

<div id="related" class="related">
    {% include 'funding/related.html' %}
</div>

<div class="cleared"></div>

<div class="discussion_column">
    {% if project|can_answer:user %}
        <a style="margin-top: 20px; display: block" class="clickable op_larger" onclick="addMessage(null, {{project.id}})">
            {% if not project|can_answer:user %}{% trans "Create a discussion" %}{% else %}{% trans "Add a comment" %}{% endif %}
        </a>
    {% endif %}
    <div id="discussions_{{project.id}}" class="discussions">
        {% for message in project.message_set.all %}
        <div id="message_{{message.id}}_box">{% include 'messages/message.html' %}</div>
        {% empty %}
        {% if project|can_answer:user %}{% trans "Discuss" %} {{object.title}}{% endif %}
        {% endfor %}
    </div>
</div>
{% endwith %}

<script>
    currentTask = {{object.id}};
    allFeatureFunction();    
    {% if object|can_manage:user %}
    sortFeature({{object.id}});
    {% endif %}
</script>
{% else %}
{% trans "Forbidden" %}
{% endif %}
{% endblock %}
