{% extends "funding/base.html" %}
﻿﻿{% load oifilters %}
{% load i18n %}
{% block title %}{{object.title|default:_("Project")}}{% endblock %}
{% block breadcrumb %}
<div class="path-element">{{object.title}}</div>
{% endblock %}

{% block content %}
{% if object|can_read:user %}
<div class="prjbody">
    {% with object as project %}
    <div id="project_{{object.id}}" class="project">
        <div id="prjdialogue_{{object.id}}" class="popup invisible"></div>
        <div class="prjheader">
            <div>
                {% with spec=project.spec_set.all|filter_order:1 object=project %}
                <div style="position:relative; float:right" id="spec_{{object.id}}_{{spec.order}}" class="funding_space">
                    {%include 'funding/spec/spec.html'%}
                </div>
                {% endwith %}
                <div class="prj-block-fav">
                    <img onclick="favProject(174)" src="/img/icons/starTrueFunding.png" alt="{% trans 'follow the project' %}" title="{% trans 'follow the project' %}" class="clickable followicon" id="fav_174" />
                    {{object.observer_set.count}} {% blocktrans count counter=object.observer_set.count %} subscriber {% plural %} subscribers {% endblocktrans %}
                </div>
                <div class="cleared"></div>
                <div class="tasktitle" id="prjtitle_{{object.id}}" title="{{object.title}}">
                    {{object.title}}
                </div>
            </div>
            <div class="cleared"></div>
        </div>
        <div id="specs_{{project.id}}" class="prjdesc">
            {% for spec in project.all_specs_with_languages %}
                <div style="position:relative;" id="spec_{{object.id}}_{{spec.order}}" class="funding_space">
                    {% with project as object %}{%include 'funding/spec/spec.html'%}{% endwith %}
                </div>
            {% endfor %}
        </div>
        <div class="cleared"></div>
    </div>
    
    <div class="project">
        <h2 class="detail_subtitle">{% trans "Proposed features" %}</h2>
        
        <div>
            <div id="featureid_blockHead" class="statebtns center_btn"> 
                {% if object.all_not_started_tasks %}<div onclick="featureShowHide('features_0')" id="featureid_proposed" class="clickable statebtn invisible">{% trans "Proposed" %}</div>{% endif %}
                {% if object.all_progress_tasks %}<div onclick="featureShowHide('features_3')" id="featureid_progress" class="clickable statebtn invisible">{% trans "In progress" %}</div>{% endif %}
                {% if object.all_finish_tasks %}<div onclick="featureShowHide('features_4')" id="featureid_finished" class="clickable statebtn invisible">{% trans "Finished" %}</div>{% endif %}
                <div class="cleared"></div>
            </div>

            <ul class="features_manage" id="features_0">
                {% for task in object.all_not_started_tasks|filter_read:user %}
                    <li class="featurebox" id="task_{{task.id}}">
                    {% include 'funding/feature.html' %}
                    </li>
                {% endfor %}
            </ul>
            <div class="cleared"></div>

            <ul class="features_manage" id="features_3">
                {% for task in object.all_progress_tasks|filter_read:user %}
                    <li class="featurebox" id="task_{{task.id}}">
                    {% include 'funding/feature.html' %}
                    </li>
                {% endfor %}
                <div class="cleared"></div>
            </ul>

            <ul class="features_manage" id="features_4">
                {% for task in object.all_finish_tasks|filter_read:user %}
                    <li class="featurebox" id="task_{{task.id}}">
                    {% include 'funding/feature.html' %}
                    </li>
                {% endfor %}
                <div class="cleared"></div>
            </ul>
            
        </div>
    </div>
    {% endwith %}

<div class="submit_feature">
    {% if object|can_manage:user %}
    <div class="bordertitledetails">
        <p class="navtitlehome no_p_style oigreen">{% trans "What you have to do :" %}</p>
        <p>
            {% trans "You can create and edit new developments for your projects. Specify the title, make a description that explains its characteristics and determine the expected price for each. Your users can suggest other developments on the project page, you can accept / rephrase if you wish." %}
        </p>
    </div>
    <div class="blockfeatureheight column">
        <div>
            <form onsubmit="addTask(getValue('newtask_title_{{object.id}}', true), {{object.id}}, getValue('offer_{{object.id}}'), function(taskid){OIajaxCall('/funding/'+taskid+'/task', null, newDiv('features_0'))}); document.getElementById('offer_{{object.id}}').value = ''; return false">
                <table>
                    <tr>
                        <td>
                        <label class="loginlabel oigreen" for="newtask_title_{{object.id}}">{% trans "insert a title" %}</label>
                    <input type="text" class="fieldfeature" id="newtask_title_{{object.id}}" onkeyup="focusInOut('newtask_title_{{object.id}}')">
                    <div class="cleared"></div>
                            </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="loginlabel oigreen" for="offer_{{object.id}}">{% trans "Feature price" %}</label>
                            <input type="text" class="fieldfeature" id="offer_{{object.id}}" onkeyup="focusInOut('offer_{{object.id}}')">  €
                            <div class="cleared"></div>
                        </td>
                    </tr>
                </table>
                <p>{% trans "By adding this change you acknowledge <br/> that you have read and accepted the" %} <a href="/cgu">{% trans "Terms of Use" %}</a></p>
                        
            </form>
            <div class="cleared"></div>
        </div>
    </div>
    <p class="continuebtn fundingright no_p_style feature_propose" style="padding:0.5%">
        <input class="nobtnstyle clickable" type="submit" onclick="addTask(getValue('newtask_title_{{object.id}}', true), {{object.id}}, getValue('offer_{{object.id}}'), function(taskid){OIajaxCall('/funding/'+taskid+'/task', null, newDiv('features_0'))}); document.getElementById('offer_{{object.id}}').value = ''" value="{% trans 'Propose' %}">
    </p>
    {% else %}
        {% if object|can_answer:user %}
        <div class="bordertitledetails">
            <p class="navtitlehome no_p_style oigreen">{% trans "Propose a new feature" %}</p>
            <p>
                {% trans "You can propose to the developer a new feature for this project. If it is accepted by the developer, the feature will be included in the project." %}
            </p>
        </div>
        <div class="blockfeatureheight column">
            <div>
                <form onsubmit="addTask(getValue('newtask_title_{{object.id}}', true), {{object.id}}, null,function(taskid){OIajaxCall('/funding/'+taskid+'/task', null, newDiv('features_0','featurebox'))}); return false" id="newtask_{{object.id}}">
                    <table>
                        <tr>
                            <td>
                            <label class="loginlabel oigreen" for="newtask_title_{{object.id}}">{% trans "insert a title" %}</label>
                            <input type="text" class="fieldfeature" id="newtask_title_{{object.id}}" onkeyup="focusInOut('newtask_title_{{object.id}}')">
                            </td>
                        </tr>
                    </table>
                    <p>{% trans "By adding this change you acknowledge <br/> that you have read and accepted the" %} <a href="/cgu">{% trans "Terms of Use" %}</a></p>
                    
                </form>
                <div class="cleared"></div>
            </div>
        </div>
        <p class="continuebtn fundingright no_p_style feature_propose" style="padding:0.5%">
            <input class="nobtnstyle clickable" type="submit" onclick="addTask(getValue('newtask_title_{{object.id}}', true), {{object.id}}, null,function(taskid){OIajaxCall('/funding/'+taskid+'/task', null, newDiv('features_0','featurebox'))})" value="{% trans 'Propose' %}">
        </p>
        {% endif %}
    {% endif %}
    <div class="cleared"></div>
</div>
    
</div>

{% with object as project %}

<div style="float: right;width: 26%;">
    <div>
    {% if object|can_write:user %}
        <a href="edit"><div class="bidaction funding_space">{% trans "Edit your project" %}</div></a>
        <div class="bidaction clickable" onclick="showPopup(document.getElementById('pluginpopup'))">{% trans "Integrate your project" %}</div>
        <div id="pluginpopup" style="width: 120%;" class="invisible popup" onclick="document.ignoreClosePopups = true;">
            <p>{% trans "If you want to see the feature in your website, you have to" %} <span class="rewardtitle">{% trans "copy and paste the code" %}</span></p>
            <form>
                <input type="radio" name="plugintype" onclick="selectplugin({{object.id}}, this.value)" value="big">{% trans "Big" %}
                <input type="radio" name="plugintype" onclick="selectplugin({{object.id}}, this.value)" value="small">{% trans "Small" %}
                <input type="radio" name="plugintype" onclick="selectplugin({{object.id}}, this.value)" value="tiny">{% trans "Tiny" %}
                <textarea readonly id="plugincode" style="width:100%; float:right; height:65px"></textarea>
            </form>
            <div id="plugin_preview"></div>
            
            {% comment %}it is for the popup plugin{% endcomment %}
            <div id="tiny_popup" class="invisible">
                <div class="featuretitle">
                    <img class="pluginlogo" src="/img/logo_funding.png">
                    <a href="/funding/{{object.id}}" target="_blank">{{object.title}}</a>
                    <div class="cleared"></div>
                    <span style="font-size:0.7em; color:#D3CFCF">{% trans 'Proposed by' %} {{object.author.get_profile|capfirst}}</span>
                </div>
                <p class="form_center no_p_style" style="color:#0094B5">{{object.allbid_sum}}€ {% trans 'funding' %}</p>
                <p class="form_center no_p_style" style="color:#0094B5">{{object.bid_set.count}} {% trans 'users' %}</p>
                {% for funding_user in object.bid_set.all %}
                    <img title="{{funding_user}}" alt="{{funding_user}}" src="/user/getpicture/{{funding_user}}"/>
                {% endfor %}
                <span class="prj-btn_green fundingright">{% trans 'Support' %}</span>
            </div>
            <div class="cleared"></div>
        </div>
    {% endif %}
    </div>
    
    <div class="myprofile column-right project column_right_padding" style="margin-bottom: 10px;overflow: hidden;">
<!--        <div class="clickable featuretitle funding_space">{% trans "Finance software" %}</div>-->
        {% with project.descendants|filter_read:user as descendants %}
        <div>
            <div class="progressbar">
                <span id="progressbar_{{object.id}}" class="progress" style="width:{% widthratio descendants.allbid_sum|add_up:project.bid_sum project.get_selfbudget|default:descendants.allbudget 100 %}%;"></span>
                <span id="progresslabel_{{object.id}}" class="progresstitle" >{% widthratio descendants.allbid_sum|add_up:project.bid_sum project.get_selfbudget|default:descendants.allbudget 100 %} %</span>
            </div>
            <div class="cleared"></div>
            <div class="block_fund_goal">
                <div class="fundingleft fund">
                    <span class="displayblock">{% trans "Funded" %}</span>
                    <span>{{project.allbid_sum|default:0|floatformat:"-2"}} €</span>
                </div>
                
                <div class="goal">
                    <span class="displayblock">{% trans "Goal" %}</span>
                    <span class="">{{project.get_selfbudget|default:descendants.allbudget|floatformat:"-2"}} €</span>
                </div>
            </div>
            
            <div class="cleared"></div>
            
            {% with task=project plugin_width='50%' zero='0' %}
                {% include 'funding/popup_budget.html' %}
            {% endwith %}
            
            <div class="profile_info cleared">
                <img src="/img/logo_small.png" class="column">
                <p>{{project.count_all_funding_user}} {% trans "users" %}</p>
            </div>
            
            <div class="featurebtns of_close">
            {% if project.state < 4 and project|can_bid:user or not user.is_authenticated %}
                <span class="supportbtn clickable fundingleft backtoproject" onclick="showPopup(document.getElementById('bidpopup_{{project.id}}')); ">{% trans "Back the project" %}</span>
            {% endif %}
            <div class="cleared"></div>
            </div>
        </div>
        {% endwith %}
        <div class="cleared"></div>
        
        {% if project.spec_set.all|filter_order:8 or object|can_manage:user %}
        <h4 class="subtitle">{% trans "Project website" %}</h4>
            {% with spec=project.spec_set.all|filter_order:8 order=8 divid='software' %}{%include 'funding/project_detail_column_right.html'%}{% endwith %}
        {% endif %}
    </div>
    <div class="cleared"></div>
    
    <div class="myprofile" style="margin-bottom: 10px;">
        <div class="column-right column_right_padding">
            <div class="funding_space">{% trans "Project created by" %} <b><a class="oigreen" href="/user/profile/{{project.author.username}}">{{project.author.get_profile}}</a></b></div>
            
            <div class="column profile_column">
                <img class="funding_profilepicture" src="/user/getpicture/{{project.author.username}}" />
                
                <div class="profile_info cleared">
                    <img src="/img/logo_small.png" class="column">
                    <div>{{project.author.get_profile.get_created_projects.count}} {% trans "Projects created" %}</div>
                    <div>{{project.author.get_profile.get_funded_projects.count}} {% trans "Projects funded" %}</div>
                </div>
            </div>
            <div>
                {% if project.author.get_profile.bio %}<div>{% autoescape off %}{% if project.author.get_profile.bio|length > 300 %} {{project.author.get_profile.bio|oiunescape|slice:":300"}}...{% else %}{{project.author.get_profile.bio|oiunescape}}{% endif %}{% endautoescape %}</div>{% endif %}
            </div>
            {% if project.author.get_profile.personal_website %}<div class="funding_space"><a href="{{project.author.get_profile.personal_website}}" target="_blank">{{project.author.get_profile.personal_website}}</a></div>{% endif %}
            <div class="cleared"></div>
            <a class="fundingright displayblock btn_feature oigreen" href="/user/profile/{{project.author.username}}">{% trans "Full bio" %}</a>
            <div class="cleared"></div>
        </div>
    </div>
    
        {% if object.exist_rewards or object|can_manage:user %}
        <div class="myprofile" style="margin-bottom: 10px;">
            <div class="column-right column_right_padding">
                <h3 class="oigreen">{% trans "Reward" %}</h3>
                {% if object|can_manage:user %}<h4><a class="subtitle clickable" class="clickable" onclick="showPopup(document.getElementById('newreward'));">{% trans "Add a reward" %} <img src="/img/icons/addgreen.png" title="{% trans 'Add a reward' %}" alt="{% trans 'Add a reward' %}"></a></h4>{% endif %}
                
                <div id="newreward" class="invisible popup_reward" onclick="document.ignoreClosePopups = true;">
                    {% include 'funding/rewardblock.html' %}
                </div>
                
                <iframe class="filedest" name="rewardimage" id="rewardimage"></iframe>
                
                <div id="blockreward">
                {% for reward in object.reward_set.all %}
                    {% if not reward.nb_reward == 0 or object|can_manage:user %}
                    <div id="blockreward_{{reward.id}}">
                        {% if project|can_manage:user %}<img alt="{% trans 'Delete the reward' %}" title="{% trans 'Delete the reward' %}" src="/img/icons/delete.png" class="fundingright clickable" onclick="deleteReward({{project.id}}, {{reward.id}})">{% endif %}
                        <h6 class="rewardtitle">{{reward.title}}</h6>
                        <img class="fundingleft" style="max-width:130px; margin-right:10px;" src="{% if reward.image %}{{reward.image.url}}{% endif %}" alt="{% trans 'Photo that illustrate the reward' %}" title="{% trans 'Photo that illustrate the reward' %}" />
                        <p id="descriptionreward_{{reward.id}}">{{reward.description|oiunescape}}</p>
                        <div class="cleared"></div>
                        <p> <span class="rewardtitle" id="nb_reward_{{reward.id}}">{{reward.nb_reward}}</span> {% trans "remaining rewards" %} <br/> {% if project|can_manage:user %}<img src="/img/icons/addgreen.png" style="margin-left: 5%;" alt="{% trans 'plus picture' %}" title="{% trans 'Add stock reward' %}" onclick="updateStockReward('{{project.id}}', '{{reward.id}}', true)"><img src="/img/icons/remove.png" style="margin-left: 5%;" title="{% trans 'Remove stock reward' %}" alt="{% trans 'less picture' %}" onclick="updateStockReward('{{project.id}}', '{{reward.id}}', false)">{% endif %}</p>
                        <div class="cleared"></div>
                        {% if project|can_manage:user %}<img class="clickable fundingright" title="{% trans 'Description and conditions' %}" alt="{% trans 'Description and conditions' %}" src="/img/icons/edit.png" onclick="showPopup(document.getElementById('newreward_{{reward.id}}'))"/>{% endif %}   
                    </div>
                    <div id="reward_bottom_line_{{reward.id}}" class="reward_bottom_line cleared"></div>
                    {% endif %}

                    <div id="newreward_{{reward.id}}" class="invisible popup_reward" onclick="document.ignoreClosePopups = true;">
                    {% for key, value in forms.items %}
                        {% with reward_form=value %}
                            {% with "reward_form_"|int_to_string:reward.id as form %}
                                {% if form == key %}
                                    {% include 'funding/rewardblock.html' %}
                                {% endif %}
                            {% endwith %}
                        {% endwith %}
                    {% endfor %}
                    </div>
                {% endfor %}
                </div>
                <div class="cleared"></div>
            </div>
        </div>
        {% endif %}
        
        {% if project.spec_set.all|filter_order:5 or project.spec_set.all|filter_order:6 or object|can_manage:user %}
        <div class="myprofile">
            <div class="column-right column_right_padding">
                <h3 class="oigreen">{% trans "Developer's corner" %}</h3>
                {% if project.spec_set.all|filter_order:5 or object|can_manage:user %}
                <div class="column_right_dotted cleared"></div>
                <span class="corner_developpeur">{% trans "Deposit" %}</span>
                <br/><br/>
                {% with spec=project.spec_set.all|filter_order:5 order=5 divid='deposit' %}{%include 'funding/project_detail_column_right.html'%}{% endwith %}
                {% endif %}
                
                {% if project.spec_set.all|filter_order:6 or object|can_manage:user %}
                <div class="column_right_dotted cleared"></div>
                <span class="corner_developpeur">{% trans "Licence" %}</span>
                <br/><br/>
                {% with spec=project.spec_set.all|filter_order:6 order=6 divid='licence' spec_divid='spec__6_content' %}
                <a id="{{spec_divid}}" target="_blank" {% if spec.url %}href="{{spec.url}}"{% endif %}>{% if spec.text %}{{spec.text|oiunescape}}{% else %}{% trans "Unspecified" %}{% endif %}</a> 
                {% if object|can_manage:user %}<img class="clickable fundingright" title="{% trans 'Indicate the license used to distribute software' %}" alt="{% trans 'Indicate the license used to distribute software' %}" src="/img/icons/edit.png" onclick="showPopup(document.getElementById('licencedescription_{{spec.id}}'))"/>{% endif %}
                    
                <div class="popup_corner invisible" id="licencedescription_{{spec.id}}" onclick="document.ignoreClosePopups = true;">
                    
                    <div class="cleared"></div>
                    
                    <input name="spectype" id="type_{{spec_divid}}" value="3" type="hidden"/>
                    <input name="specid" id="specid_{{spec_divid}}" value="{{spec.id|default:0}}" type="hidden"/>
                    <input name="projectid" id="projectid_{{spec_divid}}" value="{{project.id}}" type="hidden"/>
                    <input name="specorder" id="specorder_{{spec_divid}}" value="{{order}}" type="hidden"/>
                    
                    <form onsubmit="saveSpec('{{spec_divid}}',{{project.id}},getValue('specorder_{{spec_divid}}'),{{spec.id|default:0}});hidePopups(); return false">
                        <span class="rewardtitle">{% trans "Indicate the license used to distribute software" %}</span>
                        <input id="text_{{spec_divid}}" type="text" value="{{spec.text|oiunescape}}">
                        <div class="cleared"></div><br/>
                        <span class="rewardtitle">{% trans "Url licence repository" %}</span><br/>
                        <input id="url_{{spec_divid}}" type="text" value="{{spec.url|default:"http://"}}">
                        <div class="cleared"></div>
                    <input id="divid_{{spec_divid}}" name="divid" type="hidden" value="{{spec_divid}}" />
                    <input alt="{% trans 'Save the description' %}" title="{% trans 'Save the description' %}" class="fundingright" type="image" src="/img/icons/ok-32.png">
                    </form>
                    
                </div>
                {% endwith %}
                {% endif %}
                <div class="cleared"></div>
            </div>
        </div>  
        {% endif %} 
    
    </div>
</div>

<div class="cleared"></div>

<div class="discussion_column">
    {% if project|can_answer:user %}
        <a style="margin-top: 20px; display: block" class="clickable op_larger" onclick="addMessage(null, {{project.id}})">
            {% if not project|can_answer:user %}{% trans "Create a discussion" %}{% else %}{% trans "Add a comment" %}{% endif %}
        </a>
    {% endif %}
    <div id="discussions_{{project.id}}" class="discussions">
        {% for message in project.message_set.all %}
        <div id="message_{{message.id}}_box">{% include 'messages/message.html' %}</div>
        {% empty %}
        {% if project|can_answer:user %}{% trans "Discuss" %} {{object.title}}{% endif %}
        {% endfor %}
    </div>
</div>
{% endwith %}

<script>
    currentTask = {{object.id}};
    allFeatureFunction();    
    {% if object|can_manage:user %}
    sortFeature({{object.id}});
    {% endif %}
</script>
{% else %}
{% trans "Forbidden" %}
{% endif %}
{% endblock %}
