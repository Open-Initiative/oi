{% extends "base.html" %}
﻿﻿{% load oifilters %}
{% load i18n %}
{% block title %}{{object.title|default:_("Project")}}{% endblock %}
{% block pagetitle %}{{object.title|default:_("Project")}}{% endblock %}
{% block nav %}
<div id="projecttree"></div>
{% endblock %}
{% block content %}
<div class="pagetop">
    <div id="tabs">
        <div class="{% ifequal view "description" %}selectedtab {% endifequal %}tab">
            <a href="description"><img class="tabicon" src="/img/icons/spec{% ifequal view "description" %}white{% endifequal %}.png"/> {% trans "description" %}</a>
        </div>
        <div class="{% ifequal view "planning" %}selectedtab {% endifequal %}tab">
            <a href="planning"><img class="tabicon" src="/img/icons/planning{% ifequal view "planning" %}white{% endifequal %}.png"/> {% trans "planning" %}</a>
        </div>
        <div class="{% ifequal view "budget" %}selectedtab {% endifequal %}tab">
            <a href="budget"><img class="tabicon" src="/img/icons/budget{% ifequal view "budget" %}white{% endifequal %}.png"/> {% trans "budget" %}</a>
        </div>
        <div class="{% ifequal view "team" %}selectedtab {% endifequal %}tab">
            <a href="team"><img class="tabicon" src="/img/icons/team{% ifequal view "team" %}white{% endifequal %}.png"/> {% trans "team" %}</a>
        </div>
    </div>
    <div id="tools">
        <img class="clickable" title="Suivre le projet" alt="Suivre le projet" src="/img/icons/starTrue.png" onclick="observeProject({{object.id}})">
        {% include 'projects/project_state.html' %}
    </div>
</div>
{% if object|can_read:user %}
{% with object as project %}
<div id="project_{{project.id}}" class="project">
    <div id="prjdialogue_{{project.id}}" class="popup invisible"></div>
    <div class="prjbody">
    {% with "projects/project_"|add:view|add:".html" as template_name %}
    {% include template_name %}
    {% endwith %}
        <div class="cleared"></div> 
    </div>
</div>
{% endwith %}
<script>
    username = '{{user.username}}';
    viewname = '{{view}}';
    oiTree = new OITree("projecttree");
    var rootdiv = oiTree.setRoot({{object.master.id}}, {{object.master.state}}, 0);
    setTaskName(rootdiv, {{object.master.id}}, "{{object.master.title}}", "{{view}}");
    rootdiv.className += " treeroot";
    {% for ancestor in object.get_path %}
        {% if not ancestor|can_read:user %}
            {% if ancestor.parent %}
                setTaskName(oiTree.nodes[{{ancestor.parent.id}}].addChild({{ancestor.id}},4),{{ancestor.id}},"...", "{{view}}");
                if(oiTable) oiTable.addFromTask({pk:{{ancestor.id}},fields:{}}, {{ancestor.parent.id}}, 0);
                    oiTree.nodes[{{ancestor.parent.id}}].shrink();
                    oiTree.nodes[{{ancestor.parent.id}}].expand();
            {% endif %}
        {% else %}
            {% if not ancestor.parent|can_read:user %}
                    setTaskName(oiTree.nodes[{{ancestor.parent.id}}].addChild({{ancestor.id}},{{ancestor.state}}),{{ancestor.id}},"{{ancestor.title}}", "{{view}}");
                    if(oiTable) oiTable.addFromTask({pk:{{ancestor.id}},fields:{}}, {{ancestor.parent.id}}, 0);
                    oiTree.nodes[{{ancestor.parent.id}}].shrink();
                    oiTree.nodes[{{ancestor.parent.id}}].expand();
            {% endif %}
            oiTree.nodes[{{ancestor.id}}].expand();
        {% endif %}
    {% endfor %}
    setActiveTask({{object.id}}{% if object.state < 4 and object|can_write:user %}, true{% endif %});
</script>
{% else %}
{% trans "Forbidden" %}
{% endif %}
{% endblock %}
